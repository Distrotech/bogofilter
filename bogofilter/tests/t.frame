#!/bin/sh

# testing framework for /bin/sh

# if run from "make check", use pid and time to name TMPDIR, 
# which will automatically be deleted.

# if run from command line, use testname and date for TMPDIR,
# and suppress directory deletion.

set -e

: ${relpath=..}

if [ -z "$RUN_FROM_MAKE" ] ; then
   NAME=`echo $0 | sed s@.*/t\.@@`
   DATE=`date +"%Y%m%d"`
   TMPDIR="$NAME.$DATE"
   rm -rf $TMPDIR
   mkdir  $TMPDIR
   SUPPRESS_DELETE="NO"
else
#   SUPPRESS_DELETE=NO
    while : ; do
	TMPDIR=./checks.$$.`date +"%Y%m%dT%H%M%S"`
	if test x$SUPPRESS_DELETE = xNO ; then TMPDIR=./outputs.`date +"%m%d"` ; fi
	[ -d $TMPDIR ] || mkdir $TMPDIR
        [ -d $TMPDIR ] && break
	sleep 1
    done
fi

if test "x$SUPPRESS_DELETE" = "x" ; then
    trap "rm -r -f core ${TMPDIR}" 0
else
    echo "Results are in ${TMPDIR}.  Remove it after testing."
fi

BOGOFILTER_DIR=$TMPDIR
export BOGOFILTER_DIR

# make GNU libc nasty and abort on memory allocation issues:
MALLOC_CHECK_=2
export MALLOC_CHECK_

${relpath}/bogofilter -n -C </dev/null
