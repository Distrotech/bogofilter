#!/bin/sh -v

set -e

# Note:  This test DOES leave its output files on the hard drive.
#	 This makes it easier to see what has happened, which is
#		especially useful when something is different.
#
#        In directory t.systest.d are:
#
#		tests   - directory containing individual output files
#		grftest.out - comparison of directories:
#			      outputs - known correct outputs
#			      tests   - outputs of the individual tests

: ${srcdir=.}
relpath="`pwd`/../.."
. ${srcdir}/../t.frame -no-db

verbose=0
if [ "$1" = "-v" ]; then
    verbose=1
fi

# Graham config
cat /dev/null > ${TMPDIR}/cfg.g

# Robinson config
cat <<EOF > ${TMPDIR}/cfg.r
robx=0.415
min_dev=0.0
EOF

# Fisher config
cat <<EOF > ${TMPDIR}/cfg.f
robx=0.415
min_dev=0.1
ham_cutoff=0.0
EOF

# Fisher tristate
cat <<EOF > ${TMPDIR}/cfg.t
robx=0.415
min_dev=0.1
ham_cutoff=0.1
terse_format = %1.1c %d
spamicity_tags = S,h,u
spamicity_formats = %6.2e %6.2e %0.6f
EOF

V="v"	# verbosity level

DEBUG_VALGRIND=" -x v -vv"
BOGOFILTER="$VAL ${relpath}/bogofilter"
BOGOUTIL="$VAL ${relpath}/bogoutil"
SYSTEST="${srcdir}"

map_rc()
{
    (
	set +e
#	echo "$@"
	eval "$@"
	a=$?
	[ $a -eq 0 ] && exit 0
	[ $a -eq 1 ] && exit 0
	exit $a
    )
}

run_test()
{
    id="$1"
    fil="$2"
    ver="$3"
    OUT="${TMPDIR}/tests/msg.$fil.$mth.$ver"
    OPTS="-$alg -t -$ver $CFG"
#echo$BOGOFILTER $OPTS ${SYSTEST}/inputs/msg.$id.txt ${TMPDIR}/tests-$alg 
    map_rc $BOGOFILTER $OPTS -I ${SYSTEST}/inputs/msg.$id.txt > ${TMPDIR}/tests-$alg 
    sed s/,.version=.*// < ${TMPDIR}/tests-$alg > $OUT
}

if [   -d ${TMPDIR}/tests ] ; then rm -f ${TMPDIR}/tests/* ; else : ; fi
mkdir -p ${TMPDIR}/tests

methods="g r f t"

for mth in $methods ; do
    alg="$mth"
    if [ "$alg" = "t" ] ; then alg=f ; else : ; fi
    BOGOFILTER_DIR="${TMPDIR}/words.$mth"
    CFG="-c ${TMPDIR}/cfg.$mth -y 0"
    export BOGOFILTER_DIR
    if [   -d $BOGOFILTER_DIR ] ; then rm -f $BOGOFILTER_DIR/* ; else : ; fi
    mkdir -p $BOGOFILTER_DIR

#echo $BOGOFILTER -$alg $CFG -s -I ${SYSTEST}/inputs/spam.mbx
      $BOGOFILTER -$alg $CFG -s -I ${SYSTEST}/inputs/spam.mbx
#echo $BOGOFILTER -$alg $CFG -n -I ${SYSTEST}/inputs/good.mbx
      $BOGOFILTER -$alg $CFG -n -I ${SYSTEST}/inputs/good.mbx

#echo $BOGOUTIL -d $BOGOFILTER_DIR/spamlist.db  $BOGOFILTER_DIR/spamlist.txt
      $BOGOUTIL -d $BOGOFILTER_DIR/spamlist.db > $BOGOFILTER_DIR/spamlist.txt
#echo $BOGOUTIL -d $BOGOFILTER_DIR/goodlist.db  $BOGOFILTER_DIR/goodlist.txt
      $BOGOUTIL -d $BOGOFILTER_DIR/goodlist.db > $BOGOFILTER_DIR/goodlist.txt

    [ $verbose -gt 0 ] && $BOGOUTIL -w $BOGOFILTER_DIR .MSG_COUNT
    #
    # run tests for msg.[1-8].txt
    #
    files=`ls ${SYSTEST}/inputs/msg.[12].txt`
    files=`ls ${SYSTEST}/inputs/msg.1.txt`
    files=`ls ${SYSTEST}/inputs/msg.?.txt`
    for msg in $files ; do
	tst=`echo $msg | sed s@${SYSTEST}/inputs/msg.@@ | sed s@.txt@@`
	args="$tst $tst $V"
	run_test $args
    done

    rm -f ${TMPDIR}/tests-$alg
done

#exit

OUT="grftest.out"

printf "%2s     %-10s   %-10s   %-10s   %-10s\n" id graham robinson fisher tristate > ${TMPDIR}/tests/$OUT
for out in ${TMPDIR}/tests/msg.?.r.$V ; do
    id=`echo $out | sed s@${TMPDIR}/tests/msg.@@ | sed s@.r.$V@@`
    g=`head -1 ${TMPDIR}/tests/msg.$id.g.$V | tr "NY" "hS"`
    r=`head -1 ${TMPDIR}/tests/msg.$id.r.$V | tr "NY" "hS"`
    f=`head -1 ${TMPDIR}/tests/msg.$id.f.$V | tr "NY" "hS"`
    t=`head -1 ${TMPDIR}/tests/msg.$id.t.$V`
    printf "%2s   %c %s   %c %s   %c %s   %c %s\n" $id $g $r $f $t >> ${TMPDIR}/tests/$OUT
done

OUTPUTS=${SYSTEST}/outputs
if  [ $verbose -eq 0 ]; then
    cmp ${OUTPUTS}/$OUT ${TMPDIR}/tests/$OUT
else
    diff -u -s --brief ${OUTPUTS}/$OUT ${TMPDIR}/tests/$OUT
fi
