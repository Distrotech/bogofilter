#! /bin/sh

set -e

# Note:  When run via "make check", test output files are automatically deleted.
#	 When run from the command line, outputs files are left in directory
#	 robx.YYYYMMDD.  This is useful when something is different.
#
#	 ./inputs  - test inputs
#	 ./outputs - known correct outputs
#
#	 robx.YYYYMMDD:
#		tests   - directory containing individual output files

: ${srcdir=.}
relpath="`pwd`/../.."
NODB=1 . ${srcdir}/../t.frame

BOGOLEXER="$VAL ../../bogolexer"
BOGOFILTER="$VAL ../../bogofilter"
SYSTEST="${srcdir}"
BOGOFILTER_DIR="${TMPDIR}/tests"
export BOGOFILTER_DIR

# kill_html_comments=yes
cat <<EOF > ${TMPDIR}/cfg.y
kill_html_comments=yes
EOF

# kill_html_comments=no
cat <<EOF > ${TMPDIR}/cfg.n
kill_html_comments=no
EOF

verbose=0
if [ "$1" = "-v" ]; then
    verbose=1
fi

map_rc()
{
    (
	set +e
	eval "$@"
	a=$?
	[ $a -eq 0 ] && exit 0
	[ $a -eq 1 ] && exit 0
	exit $a
    )
}

$BOGOFILTER -f -s -C < ${srcdir}/inputs/spam.mbx
$BOGOFILTER -f -n -C < ${srcdir}/inputs/good.mbx

OUT="split.out"

files=`ls ${srcdir}/inputs/split.d/msg*`
for msg in $files ; do
    nam=`basename $msg`
    for cfg in n y ; do
	out="$TMPDIR/$nam"
	map_rc $BOGOLEXER -p -k $cfg -I $msg > $out.l$cfg
	map_rc $BOGOFILTER -vvv -f -c ${TMPDIR}/cfg.$cfg -I $msg > $out.f$cfg
	printf "%-20s %s\n" $nam.$cfg `head -1 $out.f$cfg | sed s@spamicity=@@ | tr -d "," | awk '{print $4}'` >> ${TMPDIR}/$OUT
    done
done

[ ! -z "$BF_SAVEDIR" ] && . ${srcdir}/../t.save

OUTPUTS=${SYSTEST}/outputs

if  [ $verbose -eq 0 ]; then
    cmp ${OUTPUTS}/$OUT ${TMPDIR}/$OUT
else
    [ `uname -s` = "Linux" ] && OPTS="-u -s --brief"
    diff $OPTS ${OUTPUTS}/$OUT ${TMPDIR}/tests/$OUT
fi
