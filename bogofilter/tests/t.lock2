#! /bin/sh

. ${srcdir:=.}/t.frame

filelist=`find $srcdir/* \( -type d -prune \) -o \( -type f -print \)`
cat $filelist >$TMPDIR/inp

grind() {
    a=0
    ../bogofilter -n -d $TMPDIR -xd -vvv <$TMPDIR/inp 2>> $TMPDIR/log || a=$?
    echo >>$TMPDIR/res $a
}

# this test tortures the locking
for i in 1 2 3 4 5 6 7 8 9 10 ; do
    grind &
done
wait
# check exit codes
sed '/[01]/ d' $TMPDIR/res >$TMPDIR/nook
if grep . $TMPDIR/nook >/dev/null 2>&1 ; then
    exit 1
fi
