#! /bin/sh

# Note:  When run via "make check", test output files are automatically deleted.
#	 When run from the command line, outputs files are left in directory
#	 lexer.mbx.YYYYMMDD.  This is useful when something is different.
#
#	 ./inputs  - test inputs
#	 ./outputs - known correct outputs
#
#	 lexer.mbx.YYYYMMDD:
#		tests   - directory containing individual output files

NODB=1 . ${srcdir:=.}/t.frame

OUT="lexer.mbx.out"

for f in good spam ; do
    $BOGOLEXER -C -D -p $v < ${srcdir}/inputs/$f.mbx > $TMPDIR/$f.1
    sort < $TMPDIR/$f.1 | uniq > $TMPDIR/$f.2
    if  [ $verbose -ne 0 ]; then
	$BOGOLEXER -C -D -x ml -vvv -p < ${srcdir}/inputs/$f.mbx > $TMPDIR/$f.v
    fi
done

RESULT=`cat $TMPDIR/spam.2 | wc -l`.`cat $TMPDIR/good.2 | wc -l`
RESULT=`echo $RESULT | sed s@\ @@g`

# v0.16.0 - Don't create token from "Received:"
#         - Expand VERP rule
WANT="1786.4025"
# v0.16.1 - Trim X-Bogosity from message header
WANT="1780.4025"
# v0.16.2 - Tag Cc: lines as To: lines.
WANT="1780.4029"
# v0.17.4 - Discard the PGP signature
#         - Special tagging for mime header parts
WANT="1787.4046"
# v0.93.1 - Fixed mime boundary problem
WANT="1787.4052"

if [ "$RESULT" != "$WANT" ] || [ $verbose -ne 0 ] ; then
    echo want: $WANT, have: $RESULT | tee $TMPDIR/$OUT
fi

[ ! -z "$BF_SAVEDIR" ] && . ${srcdir}/../t.save

test "$RESULT" = "$WANT"
