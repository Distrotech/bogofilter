#!/bin/sh

# only run this when valgrind is in the path, skip otherwise
# ("exit 77" = skip)
#
# this is a stripped-down version of t.grftest

NODB=1 . ${srcdir=.}/t.frame

if test "x$EXE_EXT" = "x_static"; then
    exit 77
fi

VALGRIND="$VALGRIND 3>${TMPDIR}/vg.out --logfile-fd=3"
( eval $VALGRIND true  ) 2>/dev/null || exit 77
if ( eval $VALGRIND false ) 2>/dev/null ; then exit 77 ; fi

# Fisher config
cat <<EOF > ${TMPDIR}/cfg.f
robx=0.415
min_dev=0.1
ham_cutoff=0.0
EOF

# Fisher tristate
cat <<EOF > ${TMPDIR}/cfg.t
robx=0.415
min_dev=0.1
ham_cutoff=0.1
terse_format = %1.1c %d
spamicity_tags = S,h,u
spamicity_formats = %6.2e %6.2e %0.6f
EOF

V="v"	# verbosity level

run_test()
{
    id="$1"
    fil="$2"
    ver="$3"
    OUT="${TMPDIR}/tests/msg.$fil.$mth.$ver"
    OPTS="-$alg -e -t -$ver $CFG"
    eval $VALGRIND $BOGOFILTER $OPTS <${SYSTEST}/inputs/msg.$id.txt \
    >${TMPDIR}/tests-$alg
    if test -s $TMPDIR/vg.out ; then cat $TMPDIR/vg.out ; exit 2 ; fi
}

if [   -d ${TMPDIR}/tests ] ; then rm -f ${TMPDIR}/tests/* ; else : ; fi
mkdir -p ${TMPDIR}/tests

for mth in f t ; do
    alg="$mth"
    if [ "$alg" = "t" ] ; then alg=f ; else : ; fi
    BOGOFILTER_DIR="${TMPDIR}/words.$mth"
    CFG="-c ${TMPDIR}/cfg.$mth -y 0"
    export BOGOFILTER_DIR
    if [   -d $BOGOFILTER_DIR ] ; then rm -f $BOGOFILTER_DIR/* ; else : ; fi
    mkdir -p $BOGOFILTER_DIR
    $BOGOFILTER -$alg $CFG -s < ${SYSTEST}/inputs/spam.mbx
    $BOGOFILTER -$alg $CFG -n < ${SYSTEST}/inputs/good.mbx
#   if [ $verbose -gt 0 ] ; then $BOGOUTIL -w $BOGOFILTER_DIR .MSG_COUNT ; fi

    for msg in ${SYSTEST}/inputs/msg.3.txt ; do
	tst=`echo $msg | sed s@${SYSTEST}/inputs/msg.@@ | sed s@.txt@@`
	args="$tst $tst $V"
	run_test $args
    done

    rm -f ${TMPDIR}/tests-$alg
done
