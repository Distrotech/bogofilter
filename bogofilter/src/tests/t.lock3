#! /bin/sh

. ${srcdir:=.}/t.frame

seq="1 2 3 4 5"

# OPTS used for all
# IOPTS used for initialization
OPTS="-C -d $TMPDIR -M"
IOPTS=
if [ "$verbose" ] ; then IOPTS="$IOPTS -v" ; fi

rc=0

$BOGOFILTER $OPTS $IOPTS -n -I ${srcdir}/inputs/good.mbx
$BOGOFILTER $OPTS $IOPTS -s -I ${srcdir}/inputs/spam.mbx

trap >$TMPDIR/oldtraps
trap 'kill $pid' 1 2 3

if [ "$verbose" ] ; then echo "#### Part 1 ####" ; fi
for I in $seq ; do
    (   set +e
	$BOGOFILTER $OPTS -u -I ${srcdir}/inputs/spam.mbx 
	echo $? >>$TMPDIR/exits
    ) &
    pid="$pid $!"
done

wait
pid=

if [ "$verbose" ] ; then echo "#### Part 2 ####" ; fi
for I in $seq ; do
    (   set +e
	$BOGOFILTER $OPTS -u -p -I ${srcdir}/inputs/spam.mbx >> ${TMPDIR}.$I.out
	echo $? >>$TMPDIR/exits
    ) &
    pid="$pid $!"
done

wait
pid=

trap - 1 2 3
. $TMPDIR/oldtraps

# check for program failures
test "x`grep -v 0 $TMPDIR/exits`" = x

# check if all programs reported their code
exits=`cat $TMPDIR/exits | wc -l`
set -- $seq $seq
test $exits -eq $#
