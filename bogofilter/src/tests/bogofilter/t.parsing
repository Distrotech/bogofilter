#!/bin/sh

set -e

# Note:  When run via "make check", test output files are automatically deleted.
#	 When run from the command line, outputs files are left in directory
#	 bulkmode.YYYYMMDD.  This is useful when something is different.
#
#	 ./inputs  - test inputs
#	 ./outputs - known correct outputs
#		     esp. bulkmode.out
#
#	 bulkmode.YYYYMMDD:
#		tests   - directory containing individual output files

: ${srcdir=.}
relpath="`pwd`/../.."
NODB=1 . ${srcdir}/../t.frame

verbose=0
if [ "$1" = "-v" ]; then
    verbose=1
fi

BOGOFILTER="$VAL ${relpath}/bogofilter"
BOGOLEXER="$VAL ${relpath}/bogolexer"
BOGOUTIL="$VAL ${relpath}/bogoutil"
BOGOLEX_SH="$VAL ${srcdir}/../../../tuning/bogolex.sh"
SYSTEST="${srcdir}"

MSG="${SYSTEST}/inputs/msg.parsing.txt"
flaglist="IHT iHT IhT IHt Iht iHt ihT iht"

for flags in $flaglist ; do
    ( echo "****** " $flags " ******" ; \
    $BOGOLEXER -C -D -P$flags -p -x l -v < $MSG ) > ${TMPDIR}/parsing-$flags.out
    if  [ $verbose -ne 0 ]; then
	sort -u < ${TMPDIR}/parsing-$flags.out >  ${TMPDIR}/parsing-$flags.sor
    fi
done

for flags in $flaglist ; do
    if  [ $verbose -ne 0 ]; then
	printf "%s %d %d\n" $flags `cat ${TMPDIR}/parsing-$flags.out | wc -l` `cat ${TMPDIR}/parsing-$flags.sor | wc -l`
    fi
done

for OUT in ${srcdir}/outputs/parsing-???.out ; do
    if  [ $verbose -eq 0 ]; then
	cmp $OUT ${TMPDIR}/`basename $OUT`
    else
	diff $DIFF_BRIEF $OUT ${TMPDIR}/`basename $OUT`
    fi
done

map_rc()
{
    (
	set +e
	eval "$@"
	a=$?
	[ $a -eq 0 ] && exit 0
	[ $a -eq 1 ] && exit 0
	exit $a
    )
}

