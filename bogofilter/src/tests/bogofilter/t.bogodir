#! /bin/sh

set -e

# Note:  When run via "make check", test output files are automatically deleted.
#	 When run from the command line, outputs files are left in directory
#	 bogodir.YYYYMMDD.  This is useful when something is different.
#
#	 bogodir.YYYYMMDD:
#		tests   - directory containing individual output files

: ${srcdir=.}
relpath="`pwd`/../.."

NODB=1 . ${srcdir}/../t.frame

verbose=0
if [ "$1" = "-v" ]; then
    verbose=1
fi

HOME="${TMPDIR}/home"
mkdir $HOME
export HOME
BOGOFILTER="$VAL ${relpath}/bogofilter"
LOG="${TMPDIR}/bogodir.log"
cat /dev/null > $LOG

map_rc()
{
    (
	set +e
	echo >> $LOG "$@"
	echo >> $LOG "### expect: $expect"
	result=`eval "$@" 2>&1 | tee -a $LOG | grep open | head -1`
	ok=`echo "$result" | grep "$expect"`
	if [ -n "$ok" ] ; then
	    echo >> $LOG "### ok: $ok"
	    echo >> $LOG "PASS"
	else
	    echo >> $LOG "### got '$result'"
	    echo >> $LOG "FAIL"
	fi
	echo >> $LOG ""

	[ -z "$ok" ] && rc=1
	[ -n "$ok" ] && rc=0
	exit $rc
    )
}

#standard test (bogodir.log=3225)
OPTS=" -x d -vv -D"

#a bit more info (bogodir.log=5071)
#OPTS=" -x dcw -vvv -D"

#everything (bogodir.log=5416)
#OPTS=" -x cdfghlmrstw -vvvv -D"

# just $HOME should display /home/userid
unset BOGOFILTER_DIR
expect="$HOME/.bogofilter"
map_rc $BOGOFILTER $OPTS -C < /dev/null

cat <<EOF > ${TMPDIR}/bogodir.cf
bogofilter_dir=${TMPDIR}/bogoconf.d
EOF

# config file should display "command"
expect="${TMPDIR}/bogoconf.d"
map_rc $BOGOFILTER $OPTS -c ${TMPDIR}/bogodir.cf < /dev/null

# command line and config file should display "command.d"
expect="${TMPDIR}/command.d"
map_rc $BOGOFILTER $OPTS -c ${TMPDIR}/bogodir.cf -d ${TMPDIR}/command.d < /dev/null

# $HOME and $BOGOFILTER_DIR should display $TMPDIR
BOGOFILTER_DIR=$TMPDIR
export BOGOFILTER_DIR

expect="$BOGOFILTER_DIR"
map_rc $BOGOFILTER $OPTS -C < /dev/null
map_rc $BOGOFILTER $OPTS -c ${TMPDIR}/bogodir.cf < /dev/null

# command line should display "command.d"
expect="${TMPDIR}/command.d"
map_rc $BOGOFILTER $OPTS -C -d ${TMPDIR}/command.d < /dev/null
map_rc $BOGOFILTER $OPTS -c ${TMPDIR}/bogodir.cf -d ${TMPDIR}/command.d < /dev/null
