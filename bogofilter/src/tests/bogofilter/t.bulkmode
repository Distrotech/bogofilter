#!/bin/sh

set -e

# Note:  When run via "make check", test output files are automatically deleted.
#	 When run from the command line, outputs files are left in directory
#	 bulkmode.YYYYMMDD.  This is useful when something is different.
#
#	 ./inputs  - test inputs
#	 ./outputs - known correct outputs
#		     esp. bulkmode.out
#
#	 bulkmode.YYYYMMDD:
#		tests   - directory containing individual output files

: ${srcdir=.}
relpath="`pwd`/../.."
NODB=1 . ${srcdir}/../t.frame

verbose=0
if [ "$1" = "-v" ]; then
    verbose=1
fi

BOGOFILTER="$VAL ${relpath}/bogofilter"
BOGOLEXER="$VAL ${relpath}/bogolexer"
BOGOUTIL="$VAL ${relpath}/bogoutil"
BOGOLEX_SH="$VAL ${srcdir}/../../../tuning/bogolex.sh"
SYSTEST="${srcdir}"

export BOGOFILTER
export BOGOLEXER
export BOGOUTIL

map_rc()
{
    (
	set +e
	eval "$@"
	a=$?
	[ $a -eq 0 ] && exit 0
	[ $a -eq 1 ] && exit 0
	exit $a
    )
}

mth="f"
BOGOFILTER_DIR="${TMPDIR}"
CFG="-c ${TMPDIR}/cfg.$mth -y 0"
export BOGOFILTER_DIR
if [   -d $BOGOFILTER_DIR ] ; then rm -f $BOGOFILTER_DIR/* ; else : ; fi
mkdir -p $BOGOFILTER_DIR
$BOGOFILTER -$mth $CFG -s < ${SYSTEST}/inputs/spam.mbx
$BOGOFILTER -$mth $CFG -n < ${SYSTEST}/inputs/good.mbx
#$BOGOUTIL -d $BOGOFILTER_DIR/spamlist.db > $BOGOFILTER_DIR/spamlist.txt
#$BOGOUTIL -d $BOGOFILTER_DIR/goodlist.db > $BOGOFILTER_DIR/goodlist.txt
[ $verbose -gt 0 ] && $BOGOUTIL -w $BOGOFILTER_DIR .MSG_COUNT

BOGOFILTER_DIR="${TMPDIR}"
export BOGOFILTER_DIR

#V="-vvv"	# verbosity level
OPT="-t -v -D $V"
pattern="${SYSTEST}/inputs/msg.?.txt"

CFG="${TMPDIR}/test.cf"

# Fisher tristate

cat <<EOF > $CFG
robx=0.415
min_dev=0.1
ham_cutoff=0.1
spam_cutoff=0.95
terse_format = %1.1c %d
spamicity_tags = S,h,u
spamicity_formats = %6.2e %6.2e %0.6f
strict_check=no
block_on_subnets=yes
header_line_markup=yes
replace_nonascii_characters=yes
EOF

#
# run tests for msg.[1-8].txt
#

BOGOFILTER="$BOGOFILTER -c $CFG $OPT"

# test scoring of individual files

NAME="bulk-single"
( for f in $pattern ; do echo $f `$BOGOFILTER -e -I $f` ; done ) | \
    sed s@.*inputs/@./inputs/@ >${TMPDIR}/$NAME.out

# test scoring of files listed on stdin

NAME="bulk-stdin"
ls $pattern | $BOGOFILTER -b | \
    sed s@.*inputs/@./inputs/@ >${TMPDIR}/$NAME.out

# test scoring of files listed on linend

NAME="bulk-linend"
$BOGOFILTER -B `ls $pattern` | \
    sed s@.*inputs/@./inputs/@ >${TMPDIR}/$NAME.out

# test scoring each file twice (using linend)

NAME="bulk-double-1"
for f in $pattern ; do 
    map_rc $BOGOFILTER -B $f $f | \
	sed s@.*inputs/@./inputs/@ >> ${TMPDIR}/$NAME.tmp
done
sort -u < ${TMPDIR}/$NAME.tmp > ${TMPDIR}/$NAME.out

# test scoring each file twice (using linend), when files are without "From " lines

NAME="bulk-double-2"
for f in $pattern ; do 
    t="${TMPDIR}/`basename $f`"
    grep -v "^From "< $f > $t
    map_rc $BOGOFILTER -B $t $t | \
	sed s@.*/@./inputs/@ >> ${TMPDIR}/$NAME.tmp
done
sort -u < ${TMPDIR}/$NAME.tmp > ${TMPDIR}/$NAME.out

# test scoring of individual files using msg-count format

NAME="bogolex-single"
for f in $pattern ; do 
    map_rc "$BOGOLEX_SH -c $CFG < $f | $BOGOFILTER >> ${TMPDIR}/$NAME.out"
done

# test scoring of mbox batch of msg-count messages

NAME="bogolex-mbox"
cat $pattern >> ${TMPDIR}/test.fr

map_rc $BOGOFILTER -M < ${TMPDIR}/test.fr > ${TMPDIR}/$NAME.out

NAME="bogolex-batch"
cat /dev/null > ${TMPDIR}/test.bl
for f in $pattern ; do 
    map_rc $BOGOLEX_SH -c $CFG < $f >> ${TMPDIR}/test.bl
done

map_rc $BOGOFILTER < ${TMPDIR}/test.bl > ${TMPDIR}/$NAME.out

[ ! -z "$BF_SAVEDIR" ] && . ${srcdir}/../t.save

OUTPUTS=${SYSTEST}/outputs

CORRECT="${OUTPUTS}/bulkmode.out"

for OUT in ${TMPDIR}/bulk-*.out ; do
    if  [ $verbose -eq 0 ]; then
	cmp $CORRECT $OUT
    else
	diff $DIFF_BRIEF $CORRECT $OUT
    fi
done

CORRECT="${OUTPUTS}/bogolex.out"

for OUT in ${TMPDIR}/bogolex-*.out ; do
    if  [ $verbose -eq 0 ]; then
	cmp $CORRECT $OUT
    else
	diff $DIFF_BRIEF $CORRECT $OUT
    fi
done
