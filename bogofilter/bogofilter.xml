<?xml version="1.0" encoding="ISO-8859-1"?>
<!DOCTYPE refentry PUBLIC "-//OASIS//DTD DocBook XML V4.1.2//EN"
                   "http://www.oasis-open.org/docbook/xml/4.1.2/docbookx.dtd">
<refentry id='bogofilter.1'>
<refmeta>
<refentrytitle>bogofilter</refentrytitle>
<manvolnum>1</manvolnum>
</refmeta>
<refnamediv id='name'>
<refname>bogofilter</refname>
<refpurpose>fast Bayesian spam filter</refpurpose>
</refnamediv>
<refsynopsisdiv id='synopsis'>

<cmdsynopsis>
  <command>bogofilter</command>
  <arg choice='opt'>-h</arg>
  <arg choice='opt'>-s</arg>
  <arg choice='opt'>-n</arg>
  <arg choice='opt'>-S</arg>
  <arg choice='opt'>-N</arg>
  <arg choice='opt'>-d <replaceable>dir</replaceable></arg>
  <arg choice='opt'>-l <replaceable>tag</replaceable></arg>
  <arg choice='opt'>-o <replaceable>value</replaceable></arg>
  <arg choice='opt'>-p</arg>
  <arg choice='opt'>-e</arg>
  <arg choice='opt'>-g</arg>
  <arg choice='opt'>-r</arg>
  <arg choice='opt'>-f</arg>
  <arg choice='opt'>-R</arg>
  <arg choice='opt'>-u</arg>
  <arg choice='opt'>-v</arg>
  <arg choice='opt'>-V</arg>
  <arg choice='opt'>-x <replaceable>flags</replaceable></arg>
  <arg choice='opt'>-c <replaceable>filename</replaceable></arg>
  <arg choice='opt'>-C</arg>
  <arg choice='opt'>-q</arg>
  <arg choice='opt'>-F</arg>
</cmdsynopsis>

</refsynopsisdiv>

<refsect1 id='description'><title>DESCRIPTION</title>
<para><application>Bogofilter</application> is a Bayesian spam filter.
In its normal mode of operation, it takes an email message or other
text on standard input, does a statistical check against lists of
"good" and "bad" words, and returns a status code indicating whether
or not the message is spam.  Bogofilter is designed with fast
algorithms, uses the Berkeley DB for fast startup and lookups,
coded directly in C, and tuned for speed, so it can be used for
production by sites that process a lot of mail.</para>
</refsect1>

<refsect1 id='theory'><title>THEORY OF OPERATION</title>
<para><application>Bogofilter</application> treats its input as a bag
of tokens.  Each token is checked against "good" and "bad" wordlists,
which maintain counts of the numbers of times it has occurred in
non-spam and spam mails.  These numbers are used to compute the
probability that a mail in which the token occurs is spam.  After
probabilities for all input tokens have been computed, a fixed number
of the probabilities that deviate furtherest from average are combined
using Bayes's theorem on conditional probabilities.  If the computed
probability that the input is spam exceeds a cutoff determined at 
compile time (currently 0.54),
<application>bogofilter</application> returns 0, otherwise 1.</para>

<para>While this method sounds crude compared to the more usual
pattern-matching approach, it turns out to be extremely effective.
Paul Graham's paper <ulink url="http://www.paulgraham.com/spam.html">
A Plan For Spam</ulink> is recommended reading.</para>

<para>This program substantially improves on Paul's proposal by doing smarter
lexical analysis.  In particular, hostames and IP addresses are retained
as regognition features rather than broken up. Various kinds of MTA 
cruft such as dates and message-IDs are discarded so as not to bloat
the word lists. Lex's Swiss-army-knife nature rises again.</para>

<para>Another seeming improvement is that this program offers Gary
Robinson's suggested modifications (S and f(w) but not g(w)) to the
calculations.  These modifications are described in Robinson's paper <ulink
url="http://radio.weblogs.com/0101454/stories/2002/09/16/spamDetection.html">
Spam Detection</ulink>.</para>

<para>Since then, Robinson and others have
realized that the S calculation can be further optimized: if a vector of
length k contains random, uniformly-distributed probabilities p, then
-2 * sum(ln(p)) is distributed as chi-squared with 2n degrees of
freedom.  This is believed to be the most sensitive test of the
hypothesis that the vector of probabilities is, in fact, uniformly
distributed.  Bogofilter now offers the option of applying this test
(known as Fisher's method) to yield P(spam) and P(not spam), and using
the difference as the "spamicity" score.</para>

<para>The input may be one message or many.  Messages are broken up
on From_ lines.  The algorithm is relatively insensitive to message
miscounts.</para>

<para>For speed, MIME and other attachments are not decoded.</para>
</refsect1>

<refsect1 id='options'><title>OPTIONS</title>
<para>Without command-line options, <application>bogofilter</application>
returns 1 if the message is non-spam, 0 if it is spam.  The non-spam
wordfile is created if absent.</para>

<para>The <option>-h</option> option prints the help message and exits.</para>

<para>The <option>-s</option> option tells <application>bogofilter</application>
to register the text presented on standard input as spam.  The spam
wordfile is created if absent.</para>

<para>The <option>-n</option> option tells
<application>bogofilter</application> to register the text presented
on standard input as non-spam.</para>

<para>The <option>-S</option> option tells
<application>bogofilter</application> to register the text presented
on standard input as spam and to undo a prior registration of the
same message as non-spam.</para>

<para>The <option>-N</option> option tells
<application>bogofilter</application> to register the text presented
on standard input as non-spam and to undo a prior registration of the
same message as spam.</para>

<para>The <option>-u</option> option tells
<application>bogofilter</application> to register the message's text 
after classifying it as spam or non-spam.  A spam message will be registered
on the spamlist and a non-spam message on the goodlist.  If using the
Robinson-Fisher method and the classification is "unsure", the message will
not be registered.</para>

<para>The <option>-d</option><replaceable> dir</replaceable> option
    allows you to set the directory under which wordlists will be found
    to <replaceable>dir</replaceable>. If omitted, the default directory
    will be <filename>$BOGOFILTER_DIR</filename> if
    <envar>BOGOFILTER_DIR</envar> is set and
    <filename>$HOME/.bogofilter</filename> otherwise.</para>

<para>The <option>-l <replaceable>tag</replaceable></option> (log) option writes an informational line
    to the system log each time <application>bogofilter</application> is run.
    The information logged depends on how <application>bogofilter</application>
    is run.  The option allows an optional tag which can be included in the information being logged.
</para>

<para>The <option>-o <replaceable>value</replaceable></option> option allows setting the spam_cutoff value
    from the command line.
</para>

<para>A classification run will generate (we are not showing the date
    and host part here):

presentation):
<screen>
bogofilter[1412]: X-Bogosity: No, spamicity=0.000227
bogofilter[1415]: X-Bogosity: Yes, spamicity=0.998918
</screen></para>
<para>Using '-u' to classify a message and update a wordlist will
    produce (one a single line):
    <screen>
bogofilter[1426]: X-Bogosity: Yes, spamicity=0.998918,
  register -s, 329 words, 1 messages
    </screen></para>
    <para>Registering words ('-l' and '-s', '-n', '-S', or '-N') will produce:
	<screen>
bogofilter[1440]: register-n, 255 words, 1 messages
    </screen>
</para>

<para>The <option>-p</option> (passthrough) option writes a copy of
the input mail to the output with an X-Bogosity header (in the
style of SpamAssassin) inserted.  The header will begin with "Yes" or
"No" according as the mail is judged to be spam or non-spam
respectively.</para>

<para>The <option>-e</option> (embed) option is only effective when
    <option>-p</option> is also active. If both options are used, then
    bogofilter will exit with code 0 even if the mail is not spam. This
    simplifies using bogofilter from procmail or maildrop.</para>

<para>The <option>-u</option> (update) option tells
<application>bogofilter</application> to update the appropriate
wordfile automatically.  If the text presented on standard input is
spam, the spam wordfile will be updated.  If the text is not spam, the
good wordfile will be updated. Effectively this option runs
<application>bogofilter</application> with the <option>-s</option> or
<option>-n</option> flag, as appropriate.  (Caution is urged in the use
of this capability, as any classification errors
<application>bogofilter</application> may make will be preserved and
accumulated until corrected with the <option>-S</option> and
<option>-N</option> options.)</para>
  
<para>The <option>-v</option> option produces a report to standard 
output on <application>bogofilter</application>'s analysis af the
input. Each additional <option>v</option> will increase the verbosity of
the output, up to a maximum of 4.  With <option>-vv</option>, the report
lists the tokens with highest deviation from a mean of 0.5 association
with spam.</para>

<para>The Robinson method is the default algorithm used for computing a
message's spamicity score, unless <application>bogofilter</application> 
has been compiled without it, by using the 
<option>--disable-robinson-method</option> option to the configure
script.  The method to be used can be specified on the command line or
in the configuration file.</para>

<para>The <option>-g</option> option selects the original Graham form
of the calculation method.</para>

<para>The <option>-r</option> option selects the Robinson modifications
to the calculation method.  This is automatically enabled when the
<option>-R</option> option is specified.</para>

<para>The <option>-f</option> option selects the Robinson-Fisher
modifications to the calculation method.</para>

<para>The configure script has options
<option>--disable-graham-method</option>,
<option>--disable-robinson-method</option>, and
<option>--disable-fisher-method</option> so that
<application>bogofilter</application> can be built to support a subset
of the available methods.</para>

<para>The <option>-R</option> option tells
<application>bogofilter</application> to output an R data frame in
text form on the standard output.  See the section on integration with
R, below, for further detail.  Option <option>-R</option> implies option
<option>-r</option>.</para>

<para>The <option>-V</option> option prints the version number and 
exits.</para>

<para>The <option>-x</option> option allows setting of debug classes for 
printing debug messages.</para>

<para>The <option>-c</option><replaceable>filename</replaceable> option
tells <application>bogofilter</application> to read the config file named.
</para>

<para>The <option>-C</option> option prevents bogofilter from reading
    configuration files.</para>

<para>The <option>-q</option> (quiet) suppresses warning messages.</para>

<para>The <option>-F</option> (force) ignores threshold values when printing spamicity statistics.</para>
</refsect1>

<refsect1 id='environment'><title>ENVIRONMENT</title>
    <para>
	Bogofilter will initialize its data base directory to&nbsp;
	<filename>$BOGOFILTER_DIR</filename> if <envar>BOGOFILTER_DIR</envar> is set.
	If it is not set, bogofilter
	will use <filename>$HOME/.bogofilter</filename> instead. If neither
	 <envar>BOGOFILTER_DIR</envar> nor <envar>HOME</envar> is set, the <option>-d
	    <replaceable>dir</replaceable></option> option must be present.
</para></refsect1>

<refsect1 id='configuration'><title>CONFIGURATION</title>
<para>The <application>bogofilter</application> command line allows setting of many 
options that determine how <application>bogofilter</application> operates.
File <filename>/etc/bogofilter.cf</filename> can be used to set additional
parameters that affect its operation.  File 
<filename>/etc/bogofilter.cf.example</filename> has samples of all of the parameters.
Status and logging messages can be customized for each site (see 
<filename>/etc/bogofilter.cf.example</filename>).
</para>
</refsect1>

<refsect1 id='returns'><title>RETURN VALUES</title>
<para>0 for spam; 1 for non-spam; 2 for I/O or other errors.</para>
<para>If both <option>-p</option> and <option>-e</option> are used, the
    return values are: 0 for spam or non-spam; 2 for I/O or other
    errors.</para>

<para>Error 2 usually means that the wordlist files
<application>bogofilter</application> wants to read at startup 
are missing or the hard disk has filled up in <option>-p</option> mode.</para>
</refsect1>

<refsect1 id='integration'><title>INTEGRATION WITH OTHER TOOLS</title>

<para>Use with Procmail</para>
<para>The following procmail rule will take mail on stdin and direct
it to <filename>Mail/spam</filename> if
<application>bogofilter</application> thinks it's spam:
<programlisting>:0HB:
* ? bogofilter
Mail/spam
</programlisting>

and this similar rule will also register the tokens in the mail
according to the bogofilter classification:

<programlisting>:0HB:
* ? bogofilter -u
Mail/spam
</programlisting>
</para>
<para>If <application>bogofilter</application> fails (returning 2) the
message will be treated as non-spam.</para>

<para>The following recipe (a) spam-bins anything that
<application>bogofilter</application> rates as spam, (b) adds the
words in messages rated as spam to the spam wordlist, and (c) adds the
words in messages rated as non-spam to the non-spam wordlist.  With
this in place, it will normally only be necessary for the user to
intervene (with <option>-N</option> or <option>-S</option>) when
<application>bogofilter</application> miscategorizes something.</para>
<programlisting>
  <lineannotation>
# filter mail through bogofilter, tagging it as spam and
# updating the word lists
</lineannotation>
:0fw
| bogofilter -u -e -p

<lineannotation>
# if bogofilter failed, return the mail to the queue, the MTA will
# retry to deliver it later
# 75 is the value for EX_TEMPFAIL in /usr/include/sysexits.h
</lineannotation>
:0e
{ EXITCODE=75 HOST }

<lineannotation>
# file the mail to <filename>spam-bogofilter</filename> if it's spam.
</lineannotation>
:0:
* ^X-Bogosity: Yes, tests=bogofilter
spam-bogofilter

</programlisting>

<para>This one is for maildrop, it automatically defers the mail and
    retries later when the xfilter command fails, use this in your
    <filename>~/.mailfilter</filename>:</para>
<programlisting>xfilter "bogofilter -u -e -p"
if (/^X-Bogosity: Yes, tests=bogofilter/)
{
  to "spam-bogofilter"
}
</programlisting>

<para>The following <filename>.muttrc</filename> lines will create
mutt macros for dispatching mail to
<application>bogofilter</application>.</para>
<programlisting>macro index d "&lt;enter-command&gt;unset wait_key\n\
&lt;pipe-entry&gt;bogofilter -n\n\
&lt;enter-command&gt;set wait_key\n\
&lt;delete-message&gt;" "delete message as non-spam"
macro index \ed "&lt;enter-command&gt;unset wait_key\n\
&lt;pipe-entry&gt;bogofilter -s\n\
&lt;enter-command&gt;set wait_key\n\
&lt;delete-message&gt;" "delete message as spam"
</programlisting>

<para>Integration with Mail Transport Agent (MTA)</para>
<procedure>
<step>
 <para><application>bogofilter</application> can also be integrated into an MTA 
  to filter all incoming mail. While the specific implementation is MTA dependent, the
  general steps are as follows</para>
</step>

<step>
 <para>Install <application>bogofilter</application> on the mail server</para>
</step>
<step>
 <para>Prime the bogofilter databases with a spam and non-spam corpus.
 Since <application>bogofilter</application> will be serving a larger community,
 it is important to prime it with a representative set of messages.</para>
</step>
<step>
 <para>Set up the MTA to invoke bogofilter on each message.
   While this is an MTA specific step, you'll probably need to use the 
   <option>-p</option>, <option>-u</option>, and <option>-e</option> options.</para>
</step>
<step>
 <para>Set up a mechanism for users to register spam/nonspam messages,
 as well as to correct mis-classifications.
 The most generic solution is to set up alias email addresses to which
 users bounce messages.</para>
</step>
<step>
<para>See the <filename>doc</filename> and <filename>contrib</filename> directories for more information</para>
</step>
</procedure>
<para>Use of R to verify <application>Bogofilter</application>
calculations</para>
<para>The -R option tells <application>bogofilter</application> to
generate an R data frame.  The data frame contains one row per token analysed.
Each such row contains an index, the token, its database "good" and "spam" 
counts (the former scaled to the size of the spam list), Robinson's f(w) for 
the token, and the natural logs of (1 - f(w)) and f(w).  There is one additional 
row at the end of the table that contains a label in the token field, followed
by Robinson's P, Q and S values and the sums of the logarithms just
mentioned.</para>

<para>The R data frame can be saved to a file and later read
into an R session (see <ulink url="http://cran.r-project.org">the R
project website</ulink> for information about the mathematics package
R).  Provided with the distribution is a simple R script (file bogo.R)
that can be used to verify <application>bogofilter</application>'s
calculations.  Instructions for its use are included in the script in
the form of comments.</para>
</refsect1>

<refsect1 id='files'><title>FILES</title>
<variablelist>
<varlistentry>
<term><filename>/etc/bogofilter.cf</filename></term>
<listitem><para>System configuration file.</para></listitem>
</varlistentry>
<varlistentry>
<term><filename>~/.bogofiltercf</filename></term>
<listitem><para>User configuration file.</para></listitem>
</varlistentry>
<varlistentry>
<term><filename>~/.bogofilter/goodlist.db</filename></term>
<listitem><para>List of good tokens.</para></listitem>
</varlistentry>
<varlistentry>
<term><filename>~/.bogofilter/spamlist.db</filename></term>
<listitem><para>List of spam tokens.</para></listitem>
</varlistentry>
</variablelist>
</refsect1>

<refsect1 id='bugs'><title>BUGS</title>
<para><application>bogofilter</application> counts messages on input 
by looking for From_ lines.  As a special case, a single message
without From_ line is counted correctly.  Multiple messages without 
intervening From_ lines will be counted as one message.</para>

<para>Bogofilter does not canonicalize the transport encoding or
    character set, sacrificing precision. We used to believe that spam
    with enclosures invariably gives itself away through cues in the
    headers and non-enclosure parts, but this is not true. This will be
    fixed in a future version.</para>
</refsect1>

<refsect1 id='author'><title>AUTHOR</title>
    <para>Eric S. Raymond <email>esr@thyrsus.com</email>.</para>
    <para>For updates, see <ulink url="http://bogofilter.sourceforge.net/">
the bogofilter project page</ulink>. </para>
</refsect1>
</refentry>
