BERKELEY DB ENVIRONMENT CODE
============================

$Id$

This document does not apply when you are installing a bogofilter
version that has been configured to use the TDB or QDBM data base
managers.

0. Definitions ---------------------------------------------------------

Whenever ~/.bogofilter appears in the text below, this is the directory
where bogofilter keeps its data base by default. If you are overriding
this directory by configuration or environment variables, replace your
actual bogofilter data base directory.

1. Overview ------------------------------------------------------------

This bogofilter version has been upgraded to use the Berkeley DB
Transactional Data Store, to be able to recover a data base after an
application or system crash.

2. Use, restrictions, caveats ------------------------------------------

Berkeley DB versions 3.2, 3.3, 4.0, 4.1 and 4.2 are known to work as of
2004-03-17. Older Berkeley DB versions may or may not work - go figure.

Berkeley DB keeps some additional statistics about locking, caching and
their efficiency. These can be obtained by running the db_stat utility
with the -e or -c option, examples:

db_stat -h ~/.bogofilter -e # environment statistics
db_stat -h ~/.bogofilter -c # lock statistics
db_stat -h ~/.bogofilter -m # buffer pool statistics
db_stat -h ~/.bogofilter -l # log statistics
db_stat -h ~/.bogofilter -t # transaction statistics

db_stat ~/.bogofilter/wordlist.db # data base statistics
   (this has also been available with the traditional bogofilter code)

The new code will store files named __db.NNN and log.NNNNNNNNNN - where
NNN are numbers - in the ~/.bogofilter directory. These MUST NOT be
removed without further consideration as they can contain update data
for the data base that must be still written back to the wordlist.db
file - this happens when there are many concurrent processes alongside a
registration process.

The Berkeley DB documentation for the db_archive utility contains all
relevant information. Read it.

The db_recover utility may remove some of these files, but it knows
about Berkeley DB internals.

3. Open issues and troubleshooting -------------------------------------

Should the bogofilter processes refuse their work with a DB_RUNRECOVERY
error, do just that - restore all log files into their old location
(make sure you take the newest version of each log file in case you have
multiple versions in the back) if the system has suffered data loss.

Then run db_recover -c -v -h ~/.bogofilter

bogofilter does not currently try to recover the environment itself as
this would require additional locking code that we do not provide at the
moment. Running db_recover should be an exception, not a common use, so
this should not hurt anybody.
