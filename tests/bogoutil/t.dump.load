#!/bin/sh

#Test database maintenance using bogoutil's dump/load capabilities.

: ${srcdir=.}

relpath="`pwd`/../.." . ${srcdir}/../t.frame

verbose=0
if [ "$1" = "-v" ]; then
    verbose=1
fi

BOGOUTIL="../../bogoutil"

BASE=t.dump.load
OUT="${TMPDIR}/$BASE.out"
DATA="${TMPDIR}/$BASE.db"
SUM="$BASE.sum"

LANG=
unset LANG
LC_ALL=
unset LC_ALL
LC_COLLATE=
unset LC_COLLATE

GREP="grep -v /output-dl-"

rm -f $DATA

#load database
$BOGOUTIL -l $DATA -y 20020815 < ${srcdir}/$BASE.inp

#dump database (no restrictions, all dates should by 'yday')
$BOGOUTIL -d $DATA -y 20020815 > ${TMPDIR}/output-dl-1.txt

#update some words, including some old dates
$BOGOUTIL -l $DATA -y 20021215 < ${srcdir}/$BASE.upd
#dump database
$BOGOUTIL -d $DATA > ${TMPDIR}/output-dl-2.txt

#confirm that updated words have different counts and dates
( diff -u ${TMPDIR}/output-dl-1.txt ${TMPDIR}/output-dl-2.txt ; echo "" ) | $GREP | tee ${TMPDIR}/diff.1.2.txt >> $OUT

#dump wordlist, excluding oldest entries
$BOGOUTIL -a 20020815 -d $DATA > ${TMPDIR}/output-dl-3.txt

#confirm exclusion of oldest entries
( diff -u ${TMPDIR}/output-dl-2.txt ${TMPDIR}/output-dl-3.txt ; echo "" ) | $GREP | tee ${TMPDIR}/diff.2.3.txt >> $OUT

#dump wordlist, excluding oldest, shortest, and longest entries
$BOGOUTIL -a 20020815 -s4,30 -d $DATA > ${TMPDIR}/output-dl-4.txt

#confirm exclusion of oldest, shortest(<, and longest entries
( diff -u ${TMPDIR}/output-dl-3.txt ${TMPDIR}/output-dl-4.txt ; echo "" ) | $GREP | tee ${TMPDIR}/diff.3.4.txt >> $OUT

rm -f $DATA

#load wordlist, excluding shortest entries
$BOGOUTIL -s5,30 -l $DATA < ${TMPDIR}/output-dl-4.txt
#dump using replace_non-ascii option
$BOGOUTIL -n -d $DATA > ${TMPDIR}/output-dl-5.txt

#confirm effect of non-ascii option
( diff -u ${TMPDIR}/output-dl-4.txt ${TMPDIR}/output-dl-5.txt ; echo "" ) | $GREP | tee ${TMPDIR}/diff.4.5.txt >> $OUT

rm -f $DATA

#load wordlist non-ascii list and dump to show value combining
$BOGOUTIL -a 20021010 -l $DATA < ${TMPDIR}/output-dl-5.txt
$BOGOUTIL -a 20021010 -d $DATA > ${TMPDIR}/output-dl-6.txt

#confirm token merging
( diff -u ${TMPDIR}/output-dl-5.txt ${TMPDIR}/output-dl-6.txt ; echo "" ) | $GREP | tee ${TMPDIR}/diff.5.6.txt >> $OUT

for i in ${TMPDIR}/output-dl-?.txt ; do
    j=$srcdir/`basename $i`
    if  [ $verbose -eq 0 ]; then
	cmp $i $j
    else
	diff -u -s --brief $i $j
    fi
done
