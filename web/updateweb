#! /bin/sh
# (C) 2004, 2007 Matthias Andree, GNU GPLv2

# This script updates the bogofilter web directory on sourceforge.

# Theory: check out everything into a staging directory, web,
# then rsync the relevant part into htdocs

# WARNING: Do not edit this file on sourceforge.net directly,
# but rather check out the CVS "web" module, edit and commit.

set -e
umask 02
LC_ALL=C ; export LC_ALL

trap 'echo "### FAILED ### >&2 ; exit 1' 0

echo "### CHECKING OUT WEB ###"
cd /home/groups/b/bo/bogofilter/web

URL=http://bogofilter.svn.sourceforge.net/svnroot/bogofilter/trunk/
CMDPFX="svn"

# check out
a="$($CMDPFX update 2>&1)"
echo "$a" | egrep -v "^(At revision|Revision)" || :

# start ourselves anew
if [ "x$NORECURSE" = x ] ; then
    echo "### RESTARTING $0 ###"
    env NORECURSE=1 $0
else
  echo "### CHECKING OUT FAQ and NEWS ###"
  FILES="bogofilter-faq.html bogofilter-faq-fr.html bogofilter-faq-it.html"
  for FILE in $FILES ; do
    $CMDPFX cat $URL/bogofilter/doc/$FILE >$FILE
  done
  $CMDPFX cat $URL/bogofilter/NEWS >NEWS

  echo "### ADJUSTING PERMISSIONS ###"
  find . -type d -exec sh -c 'chgrp -R bogofilter "{}" && chmod ug=rwX "{}"' ';'

  echo "### COPYING STAGING AREA TO htdocs/ ###"
  # copy without cruft and internal files
  rsync -aH --delete ./ ../htdocs/ --delete-excluded \
      --exclude .svn --exclude '.#*' \
      --exclude README_BEFORE_EDITING \
      --exclude .nfs* \
      --exclude updateweb \
      --exclude '*~' \
      # do not remove this comment - it is for the preceding backslash

  echo "### DONE ###"
  trap 0
fi
