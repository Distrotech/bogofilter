#! /bin/sh
# (C) 2004, 2007, 2009 Matthias Andree, GNU GPLv2

# This script updates the bogofilter web directory on sourceforge.

# Theory: check out everything into a staging directory, web,
# then rsync the relevant part into htdocs

# WARNING: Do not edit this file on sourceforge.net directly,
# but rather check out the CVS "web" module, edit and commit.


: ${SF_USER:=$(cat ~/.sfuser)}

set -e
umask 02

cd "$(dirname "$0")"

trap 'echo "### FAILED ###" >&2 ; exit 1' 0

if test "x$SF_USER" = x ; then
	echo >&2 "### SF_USER NOT FOUND ###"
	echo >&2 "Put your sourceforge.net username either in the file $HOME/.sfuser or"
	echo >&2 "in the environment variable SF_USER"
	exit 1
fi

echo "==> CHECKING OUT WEB, FAQ, AND NEWS"
URL="http://bogofilter.svn.sourceforge.net/svnroot/bogofilter/trunk/"
SVN="svn --non-interactive"
DIR="$HOME/tmp/bogofilter_web"
[ ! -d $DIR ] && mkdir $DIR

# update directory
cd ../svn/doc
$SVN up -q

FILES="bogofilter-faq.html bogofilter-faq-??.html"
for FILE in $FILES ; do
	$SVN cat $URL/bogofilter/doc/$FILE > $DIR/$FILE &
done
$SVN cat $URL/bogofilter/NEWS > $DIR/NEWS &

# update directory
cd ../../web
$SVN up -q

FILES="*.shtml"
for FILE in $FILES ; do
	$SVN cat $URL/bogofilter/web/$FILE > $DIR/$FILE &
done
wait

# check if no uncommitted files are there
a=$($SVN status -q)
if test "x$a" != x ; then
	echo >&2 "### UNCOMMITTED FILES PERSIST IN LOCAL DIRECTORY - COMMIT FIRST ###"
	echo >&2 "$a"
	exit 1
fi

echo "==> UPLOADING TO web.sourceforge.net:htdocs/"
# copy without cruft and internal files
rsync -acvH \
	--chmod=ug=rwX,o=rX \
	--delete \
	--delete-excluded \
	--exclude .nfs* \
	--exclude .svn \
	--exclude README_BEFORE_EDITING \
	--exclude updateweb \
	--exclude '*~' --exclude '*.bak' \
	--exclude '.*.swp' --exclude '#*#' \
	./  \
	$SF_USER,bogofilter@web.sourceforge.net:htdocs/

echo "==> DONE"
trap 0
