#! /bin/sh

set -e

# Note:  When run via "make check", test output files are automatically deleted.
#	 When run from the command line, outputs files are left in directory
#	 lexer.mbx.YYYYMMDD.  This is useful when something is different.
#
#	 ./inputs  - test inputs
#	 ./outputs - known correct outputs
#
#	 lexer.mbx.YYYYMMDD:
#		tests   - directory containing individual output files

: ${srcdir=.}
relpath="`pwd`/../.."

NODB=1 . ${srcdir}/../t.frame

verbose=0
if [ "$1" = "-v" ]; then
    verbose=1
fi

BOGOFILTER="$VAL ${relpath}/bogofilter"
LOG="${TMPDIR}/bogodir.log"
cat /dev/null > $LOG

map_rc()
{
    (
	set +e
	echo >> $LOG "$@"
	echo >> $LOG "### expect: $expect/goodlist.db"
	result=`eval "$@" 2>&1 | tee -a $LOG | grep open | head -1`
	ok=`echo $result | grep -w $expect/goodlist.db`
	if [ -n "$ok" ] ; then
	    echo >> $LOG "### ok: $ok"
	    echo >> $LOG "PASS"
	else
	    echo >> $LOG "### got '$result'"
	    echo >> $LOG "FAIL"
	fi
	echo >> $LOG ""

	[ -z "$ok" ] && rc=1
	[ -n "$ok" ] && rc=0
	exit $rc
    )
}


# just $HOME should display /home/userid
unset BOGOFILTER_DIR
expect="$HOME/.bogofilter"
map_rc $BOGOFILTER -x d -vv -D -C < /dev/null

cat <<EOF > ${TMPDIR}/bogodir.cf
bogofilter_dir=bogoconf.d
EOF

# config file should display "command"
expect="bogoconf.d"
map_rc $BOGOFILTER -x dc -vv -D -c ${TMPDIR}/bogodir.cf < /dev/null

# command line and config file should display "command.d"
expect="command.d"
map_rc $BOGOFILTER -x d -vv -D -c ${TMPDIR}/bogodir.cf -d command.d < /dev/null

# $HOME and $BOGOFILTER_DIR should display $TMPDIR
BOGOFILTER_DIR=$TMPDIR
export BOGOFILTER_DIR

expect="$BOGOFILTER_DIR"
map_rc $BOGOFILTER -x d -vv -D -C < /dev/null
map_rc $BOGOFILTER -x d -vv -D -c ${TMPDIR}/bogodir.cf < /dev/null

# command line should display "command.d"
expect="command.d"
map_rc $BOGOFILTER -x d -vv -D -C -d command.d < /dev/null
map_rc $BOGOFILTER -x d -vv -D -c ${TMPDIR}/bogodir.cf -d command.d < /dev/null
