#!/bin/sh

#Test database maintenance using bogoutil's dump/load capabilities.

relpath="`pwd`/.."
. ${srcdir:=.}/t.frame

verbose=0
if [ "$1" = "-v" ]; then
    verbose=1
fi

BASE="dump.load"
OUT="${TMPDIR}/$BASE.out"
DATA="${TMPDIR}/$BASE.${DB_EXT}"
SUM="$BASE.sum"

LANG=
unset LANG
LC_ALL=
unset LC_ALL
LC_COLLATE=
unset LC_COLLATE

GREP="grep -v /dump.load-"
SORT="sort"

rm -f $DATA

#load database
$BOGOUTIL -l $DATA -y 20020815 < ${srcdir}/inputs/$BASE.inp

#dump database (no restrictions, all dates should by 'yday')
$BOGOUTIL -d $DATA -y 20020815 | $SORT > ${TMPDIR}/dump.load-1.txt

#update some words, including some old dates
$BOGOUTIL -l $DATA -y 20021215 < ${srcdir}/inputs/$BASE.upd
#dump database
$BOGOUTIL -d $DATA | $SORT > ${TMPDIR}/dump.load-2.txt

#confirm that updated words have different counts and dates
( diff ${TMPDIR}/dump.load-1.txt ${TMPDIR}/dump.load-2.txt ; echo "" ) | $GREP | tee ${TMPDIR}/diff.1.2.txt >> $OUT

#dump wordlist, excluding oldest entries
$BOGOUTIL -a 20020815 -d $DATA | $SORT > ${TMPDIR}/dump.load-3.txt

#confirm exclusion of oldest entries
( diff ${TMPDIR}/dump.load-2.txt ${TMPDIR}/dump.load-3.txt ; echo "" ) | $GREP | tee ${TMPDIR}/diff.2.3.txt >> $OUT

#dump wordlist, excluding oldest, shortest, and longest entries
$BOGOUTIL -a 20020815 -s4,30 -d $DATA | $SORT > ${TMPDIR}/dump.load-4.txt

#confirm exclusion of oldest, shortest(<, and longest entries
( diff ${TMPDIR}/dump.load-3.txt ${TMPDIR}/dump.load-4.txt ; echo "" ) | $GREP | tee ${TMPDIR}/diff.3.4.txt >> $OUT

rm -f $DATA

#load wordlist, excluding shortest entries
$BOGOUTIL -s5,30 -l $DATA < ${TMPDIR}/dump.load-4.txt
#dump using replace_non-ascii option
$BOGOUTIL -n -d $DATA | $SORT > ${TMPDIR}/dump.load-5.txt

#confirm effect of non-ascii option
( diff ${TMPDIR}/dump.load-4.txt ${TMPDIR}/dump.load-5.txt ; echo "" ) | $GREP | tee ${TMPDIR}/diff.4.5.txt >> $OUT

rm -f $DATA

#load wordlist non-ascii list and dump to show value combining
$BOGOUTIL -a 20021010 -l $DATA < ${TMPDIR}/dump.load-5.txt
$BOGOUTIL -a 20021010 -d $DATA | $SORT > ${TMPDIR}/dump.load-6.txt

#confirm token merging
( diff ${TMPDIR}/dump.load-5.txt ${TMPDIR}/dump.load-6.txt ; echo "" ) | $GREP | tee ${TMPDIR}/diff.5.6.txt >> $OUT

[ ! -z "$BF_SAVEDIR" ] && . ${srcdir}/../t.save

for i in outputs/dump.load-?.out ; do
    j=${TMPDIR}/`basename $i .out`.txt
    if  [ $verbose -eq 0 ]; then
	cmp $i $j
    else
	diff $DIFF_BRIEF $i $j
    fi
done
