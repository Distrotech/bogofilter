#! /bin/sh

. ${srcdir:=.}/t.frame

filelist=`ls ${srcdir}/bogofilter/inputs/*x*`
cat $filelist >$TMPDIR/inp

CONFIG=$TMPDIR/test.cf

cat <<EOF > ${CONFIG}
robx=0.415
min_dev=1.0
replace_nonascii_characters=Y
EOF

grind() {
    a=0
    ${relpath}/bogofilter -n -d $TMPDIR -c $CONFIG <$TMPDIR/inp 2>> $TMPDIR/log || a=$?
    echo >>$TMPDIR/res $a
}

explode() {
    (
    grind &
    grind &
    grind &
    grind
    wait
    )
}

# this test tortures the locking
for i in 1 2 3 4 ; do
    explode &
done
wait

[ -n "$BF_SAVEDIR" ] && . ${srcdir}/t.save

# check exit codes -- fed up with shell junk,  use awk
ok=0
${AWK=awk} <$TMPDIR/res \
'{ 
    if ($0 ~ /^[0|1]$/) {
	ok=1; 
     } else { 
	fail=1; 
    } 
 }

 END {
    exit (1 + fail - ok)
 };'
